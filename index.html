<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FDB Port Manager — Drag/Swap UIDs</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  body { font-family: system-ui, Arial; padding: 18px; max-width: 900px; margin: auto; }
  h1 { font-size: 20px; margin-bottom: 8px; }
  table { width: 100%; border-collapse: collapse; margin-top: 12px; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align:center; }
  th { background:#f6f6f6; }
  .uid { display:inline-block; padding:6px 10px; border-radius:6px; background:#e8f6ff; cursor:grab; user-select:none; }
  .uid.dragging { opacity:0.5; }
  .uid.selected { outline:3px solid #ffcc80; background:#fff4e0; }
  .hint { color:#666; font-size:13px; margin-top:8px; margin-bottom:6px; }
  .controls {
    position: sticky;
    top: 0;
    background: white;
    padding: 8px 0;
    display: flex;
    gap: 8px;
    border-bottom: 1px solid #ddd;
    z-index: 10;
  }
  button { padding:8px 12px; border-radius:6px; border:1px solid #ccc; background:white; cursor:pointer; }
  #msg { margin-top:6px; font-weight:500; }
</style>
</head>
<body>
  <h1>FDB Port Manager</h1>
  <div class="hint">Ports are fixed. Drag a UID onto another UID to <b>swap</b> (desktop). On mobile, tap one UID to select, then tap another to swap.</div>

  <div id="msg"></div>

  <div class="controls">
    <button id="saveBtn">Save (send to bot)</button>
  </div>

  <table id="portsTable" aria-label="Ports table">
    <thead><tr><th>Port</th><th>UID</th></tr></thead>
    <tbody id="portsBody"></tbody>
  </table>

<script>
(async function(){
  const tg = window.Telegram?.WebApp;
  if (tg) tg.expand();

  const params = new URLSearchParams(window.location.search);
  const jsonUrl = params.get("json");
  if (!jsonUrl) {
    document.getElementById("portsBody").innerHTML = '<tr><td colspan="2">No ?json= URL provided in query string.</td></tr>';
    return;
  }

  async function fetchJson(){
    const r = await fetch(jsonUrl, {cache: "no-store"});
    if (!r.ok) throw new Error("Fetch failed: " + r.status);
    return await r.json();
  }

  let data;
  try {
    data = await fetchJson();
  } catch (e) {
    document.getElementById("portsBody").innerHTML = `<tr><td colspan="2">Error loading JSON: ${e}</td></tr>`;
    console.error(e);
    return;
  }

  let ports = (data.port_uid || []).map(item => ({...item}));

  const tbody = document.getElementById("portsBody");
  let selectedPort = null;

  function render(){
    tbody.innerHTML = "";
    for (const p of ports) {
      const tr = document.createElement("tr");
      const tdPort = document.createElement("td");
      tdPort.textContent = p.port;
      const tdUid = document.createElement("td");

      const div = document.createElement("div");
      div.className = "uid";
      div.textContent = p.uid;
      div.dataset.port = String(p.port);
      div.draggable = true;

      div.addEventListener("dragstart", (ev) => {
        ev.dataTransfer.setData("text/plain", ev.currentTarget.dataset.port);
        ev.currentTarget.classList.add("dragging");
      });
      div.addEventListener("dragend", (ev) => {
        ev.currentTarget.classList.remove("dragging");
      });
      div.addEventListener("dragover", (ev) => ev.preventDefault());
      div.addEventListener("drop", (ev) => {
        ev.preventDefault();
        const fromPort = ev.dataTransfer.getData("text/plain");
        const toPort = ev.currentTarget.dataset.port;
        if (!fromPort) return;
        swapUIDs(Number(fromPort), Number(toPort));
      });

      div.addEventListener("click", (ev) => {
        const portNum = Number(ev.currentTarget.dataset.port);
        if (selectedPort === null) {
          selectedPort = portNum;
          clearSelectionVisual();
          ev.currentTarget.classList.add("selected");
          showMsg(`Selected UID at port ${portNum}. Tap another UID to swap.`);
        } else if (selectedPort === portNum) {
          selectedPort = null;
          clearSelectionVisual();
          showMsg("Selection cleared.");
        } else {
          swapUIDs(selectedPort, portNum);
          selectedPort = null;
          clearSelectionVisual();
        }
      });

      tdUid.appendChild(div);
      tr.appendChild(tdPort);
      tr.appendChild(tdUid);
      tbody.appendChild(tr);
    }
  }

  function clearSelectionVisual(){
    document.querySelectorAll(".uid.selected").forEach(el => el.classList.remove("selected"));
  }

  function swapUIDs(portA, portB){
    if (portA === portB) return;
    const idxA = ports.findIndex(x => Number(x.port) === portA);
    const idxB = ports.findIndex(x => Number(x.port) === portB);
    if (idxA === -1 || idxB === -1) return;
    const tmp = ports[idxA].uid;
    ports[idxA].uid = ports[idxB].uid;
    ports[idxB].uid = tmp;
    render();
    showMsg(`Swapped UID port ${portA} ⇄ port ${portB}`);
    console.log("ports after swap:", ports);
  }

document.getElementById("saveBtn").addEventListener("click", () => {
    const payload = {
      action: "save",
      port_uid: ports,
      fdb: data.fdb,
      splitter: data.splitter
    };
    if (tg) tg.sendData(JSON.stringify(payload));
});



  function showMsg(txt, isErr=false){
    const el = document.getElementById("msg");
    el.textContent = txt;
    el.style.color = isErr ? "crimson" : "green";
  }

  render();
})();
</script>
</body>
</html>
